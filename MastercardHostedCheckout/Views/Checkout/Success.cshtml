@{
    ViewData["Title"] = "Payment Successful";
}
<div class="container mt-5 text-center">

    <div id="loading" class="spinner-border text-primary" role="status"></div>

    <div id="successContent" class="card shadow-sm p-5" style="display:none;">
        <div class="mb-4">
            <i class="bi bi-check-circle-fill text-success" style="font-size: 4rem;"></i>
        </div>

        <h1 class="display-5 fw-bold mb-3">Thank You!</h1>
        <p class="lead mb-4">Your payment was processed successfully.</p>

        <div class="alert alert-light border text-start d-inline-block p-4">
            <p class="mb-1">
                <strong>Order ID:</strong>
                <code class="text-primary">@ViewBag.OrderId</code>
            </p>

            <p class="mb-1">
                <strong>Status:</strong>
                <span class="badge bg-success" id="paymentStatus">Verifying...</span>
            </p>

            <p class="mb-1">
                <strong>Amount Paid:</strong>
                <span id="paidAmount" class="fw-bold">@ViewBag.Amount</span>
                @ViewBag.Currency
            </p>

            <p class="mb-0">
                <strong>Gateway Code:</strong>
                <code id="gatewayCode">--</code>
            </p>
        </div>

        <div class="mt-4">
            <a asp-action="Index" class="btn btn-primary px-5 py-2">
                Return to Shop
            </a>
        </div>
    </div>

    <div id="errorContent" class="alert alert-danger" style="display:none;">
        <h3>Payment Verification Failed</h3>
        <p id="errorMessage"></p>
        <a asp-action="Index" class="btn btn-outline-danger">Try Again</a>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async function () {

        const orderId = "@ViewBag.OrderId";
        const merchantId = "@ViewBag.MerchantId";

        if (!orderId) {
            showError("OrderId missing.");
            return;
        }

        try {
            // 🔥 نتحقق من حالة الطلب من السيرفر
            const res = await fetch(`/api/payment/verify?orderId=${orderId}&merchantId=${merchantId}`);

            if (!res.ok) {
                const txt = await res.text();
                throw new Error(txt);
            }

            const data = await res.json();

            const result = data.result;
            const gatewayCode = data.gatewayCode ?? "UNKNOWN";

            // ✅ نجاح فعلي فقط
            if (result === "SUCCESS" &&
                (gatewayCode === "APPROVED" || gatewayCode === "CAPTURED")) {

                showSuccess(gatewayCode);
            } else {
                throw new Error(data.message || "Payment not approved");
            }

        } catch (err) {
            showError(err.message);
        }

        function showSuccess(code) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('successContent').style.display = 'block';
            document.getElementById('paymentStatus').innerText = "CAPTURED";
            document.getElementById('gatewayCode').innerText = code;
        }

        function showError(msg) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorContent').style.display = 'block';
            document.getElementById('errorMessage').innerText = msg;
        }
    });
</script>
