@{
    ViewData["Title"] = "Processing Payment";
}

<div class="text-center mt-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Redirecting to Mastercard Hosted Checkout...</p>
</div>

<script src="https://test-gateway.mastercard.com/static/checkout/checkout.min.js?version=72"
        data-error="errorCallback"
        data-cancel="cancelCallback"
        data-complete="completeCallback">
</script>

<script>
    const orderId = "@ViewBag.OrderId";
    const sessionId = "@ViewBag.SessionId";
    const merchantId = "@ViewBag.MerchantId";
    const authTransactionId = "@ViewBag.AuthTransactionId";

    function errorCallback(err) {
        console.error("Mastercard Checkout Error Object:", err);
        alert("Payment error: " + (err?.cause || "Unknown"));
        location.href = "/Checkout/Error";
    }

    function cancelCallback() {
        alert("Payment cancelled");
        location.href = "/Checkout/Index";
    }

    async function completeCallback(resultIndicator, sessionVersion) {
        try {
            console.log("3DS complete, calling PAY API...");

            const res = await fetch("/api/payment/pay", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    orderId: orderId,
                    sessionId: sessionId,
                    authTransactionId: authTransactionId
                })
            });

            const data = await res.json();
            console.log("PAY response:", data);

            if (res.ok) {
                window.location.href =
                    `/Checkout/Success?orderId=${orderId}&sessionId=${sessionId}&merchantId=${merchantId}`;
            } else {
                alert("Payment failed: " + (data?.error || "Unknown error"));
                location.href = "/Checkout/Error";
            }

        } catch (e) {
            console.error("PAY API error:", e);
            alert("PAY API error");
            location.href = "/Checkout/Error";
        }
    }

    Checkout.configure({
        session: { id: sessionId }
    });

    Checkout.showPaymentPage();
</script>
