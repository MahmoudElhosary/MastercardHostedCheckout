@page
@model dynamic
<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Pay</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://test-gateway.mastercard.com/static/checkout/checkout.min.js"
            data-error="errorCallback"
            data-cancel="cancelCallback"
            data-complete="completeCallback"></script>
</head>
<body class="container py-5">
    <div class="card shadow-sm mx-auto" style="max-width: 400px;">
        <div class="card-body text-center">
            <h3 class="card-title">Checkout</h3>
            <p class="text-muted">Test Order - 1.000 KWD</p>
            <button id="payBtn" class="btn btn-primary btn-lg w-100" onclick="startPay()">Pay Now</button>
        </div>
    </div>

    <script>
        async function startPay() {
          const btn = document.getElementById("payBtn");
          btn.disabled = true;
          btn.innerText = "Processing...";

          try {
            const r = await fetch("/api/mpgs/session", { method: "POST" });
            const data = await r.json();

            if (data.sessionId) {
              Checkout.configure({
                session: { id: data.sessionId },
                // 🎯 هنا بنحل مشكلة "Add Apt #" برمجياً بدون ما نغير السيرفر
                billing: {
                    address: {
                        street: 'Al-Hamra Tower, 15th Floor',
                        city: 'Kuwait City',
                        postcode: '12345',
                        country: 'KWT'
                    }
                },
                interaction: {
                    displayControl: {
                        billingAddress: 'HIDE' // بيخفي الفورم المزعج
                    }
                }
              });

              Checkout.showPaymentPage();
            } else {
              alert("Failed: " + JSON.stringify(data));
              btn.disabled = false;
              btn.innerText = "Pay Now";
            }
          } catch (e) {
            console.error("Error:", e);
            btn.disabled = false;
            btn.innerText = "Pay Now";
          }
        }

        // الدالة دي ضرورية عشان تعرف العميل راح فين بعد الـ OTP
        function completeCallback(resultIndicator, sessionVersion) {
            // بنرجعه لصفحة Success اللي عملناها سوا
            window.location.href = `/Home/Success?orderId=${orderId}`;
        }

        function errorCallback(err) {
          console.error("MPGS error:", err);
          alert("Payment error: " + (err?.cause || "unknown"));
          location.reload();
        }

        function cancelCallback() {
          alert("Cancelled");
          location.reload();
        }
    </script>
</body>
</html>